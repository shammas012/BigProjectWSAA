{% extends 'master.html' %}

{% block content %}
<h2>All Tickets</h2>
<table class="table table-striped">
  <thead>
    <tr>
      <th>#</th>
      <th>Key</th>
      <th>Summary</th>
      <th>Status</th>
      <th>Reporter</th>
      <th>Assignee</th>
      <th>Created At</th>
    </tr>
  </thead>
  <tbody>
    {% for ticket in tickets %}
    <tr>
      <td>{{ loop.index + offset }}</td>
      <td><a href="/tickets/{{ ticket.key }}">{{ ticket.key }}</a></td>
      <td>{{ ticket.summary }}</td>
      <td>{{ ticket.status.description if ticket.status else '—' }}</td>
      <td>{{ ticket.Reporter.fullname if ticket.Reporter else '—' }}</td>
      <td>{{ ticket.Assignee.fullname if ticket.Assignee else '—' }}</td>
      <td>{{ ticket.createdAt.strftime('%Y-%m-%d %H:%M') }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<p class="text-muted">
  Showing {{ offset + 1 }} - {{ offset + tickets|length }} of {{ total }}
</p>

<div id="ticketList" class="mt-4"></div> 

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  //bearer token writing to console from master.html, but not appearing in the request header. something to fix in phase 2.
  authFetch('/api/tickets')
    .then(res => res.json())
    .then(data => {
      console.log("API Response:", data);
    //   document.getElementById('ticketList').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>'; // for debugging only
    })
    .catch(err => {
      console.error("API Error:", err);
      document.getElementById('ticketList').textContent = 'Error loading tickets';
    });
});
</script>
{% endblock %}
